"""
ðŸ‘» PHANTOM - Privilege Escalation Checker

Check for privilege escalation opportunities.
"""

from typing import Dict, Any, List
from phantom.logger import get_logger
from phantom.config import PhantomConfig

logger = get_logger("phantom.post_exploit.privesc")


class PrivEscChecker:
    """Check for privilege escalation vectors."""
    
    def __init__(self, config: PhantomConfig):
        self.config = config
        logger.info("Privilege escalation checker initialized")
    
    async def check(self, target_os: str, current_user: str) -> Dict[str, Any]:
        """
        Check for privilege escalation opportunities.
        
        Args:
            target_os: Operating system (windows, linux, macos)
            current_user: Current user context
            
        Returns:
            Potential privilege escalation vectors
        """
        logger.info(f"Checking privilege escalation for {target_os}")
        
        results = {
            "os": target_os,
            "user": current_user,
            "vectors": [],
        }
        
        if target_os.lower() == "linux":
            results["vectors"] = await self._check_linux_privesc()
        elif target_os.lower() == "windows":
            results["vectors"] = await self._check_windows_privesc()
        
        logger.info(f"Found {len(results['vectors'])} potential vectors")
        return results
    
    async def _check_linux_privesc(self) -> List[Dict[str, Any]]:
        """Check Linux privilege escalation vectors."""
        vectors = [
            {
                "name": "SUID Binaries",
                "description": "Check for SUID binaries that can be exploited",
                "command": "find / -perm -4000 2>/dev/null",
            },
            {
                "name": "Sudo Configuration",
                "description": "Check sudo permissions",
                "command": "sudo -l",
            },
            {
                "name": "Kernel Exploits",
                "description": "Check kernel version for known exploits",
                "command": "uname -a",
            },
        ]
        return vectors
    
    async def _check_windows_privesc(self) -> List[Dict[str, Any]]:
        """Check Windows privilege escalation vectors."""
        vectors = [
            {
                "name": "Unquoted Service Paths",
                "description": "Services with unquoted paths",
                "command": 'wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\\windows\\\\" |findstr /i /v """',
            },
            {
                "name": "AlwaysInstallElevated",
                "description": "Check if AlwaysInstallElevated is enabled",
                "command": "reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated",
            },
        ]
        return vectors
